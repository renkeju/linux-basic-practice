
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <title>5.3 自动化管理任务 &#8212; 《Linux 基础实践入门》 alpha 文档</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/translations.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
<link rel="stylesheet" type="text/css" href="../_static/handsontable.full.min.css">
<script src="../_static/handsontable.full.min.js"></script>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>5.3 自动化管理任务<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="section" id="id2">
<h2>任务和程序<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>您可以通过在shell脚本中编写多个命令来定义任务。此外，还可以使用cron和at命令在指定的日期自动运行脚本。</p>
<p>在本节中，我们将在CentOS中创建一个可自动执行以下任务的脚本，并将其注册到cron中：</p>
<p>① 检查主机上注册的所有用户的账户从当前日期到过期日期的天数。</p>
<p>③ 在标准输出中显示①的运行结果</p>
<p>③ 将②的结果发送给管理员</p>
</div>
<div class="section" id="id3">
<h2>脚本内容<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>以下是要执行的shell脚本（check.sh）的简要说明。在本示例中，check.sh 文件保存在根目录下且在根目录下运行。</p>
<div class="highlight-none notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span>#!/bin/bash

if [ -e expire-check.tmp ]; then
    rm -f expire-check.tmp
fi

today=`expr \`date +%s\` / 60 / 60 / 24`
IFS=:
n=0

while read {a..i}; do
    if [ &quot;$b&quot; != &#39;*&#39; ] &amp;&amp; [ &quot;$b&quot; != &quot;!!&quot; ] &amp;&amp; [ -n &quot;$h&quot; ]; then
        echo $a:$&#39;\t&#39;$&#39;\t&#39; `expr $h - $today` 天 &gt;&gt; expire-check.tmp
        n=`expr $n + 1`
    fi
done &lt; /etc/shadow

echo 用户:$&#39;\t&#39;$&#39;\t&#39;剩余天数 &gt; expire-check.list
sort -g -k 2 expire-check.tmp &gt;&gt; expire-check.list
echo &quot;（属于过期账户的用户：${n}人，当前时间`date +%x`）&quot; &gt;&gt; expire-check.list
cat expire-check.list

mail -s &quot;`date`: expire-check&quot; root@localhost.localdomain &lt; expire-check.list
</pre></div>
</td></tr></table></div>
<ul>
<li><p>第一行</p>
<blockquote>
<div><p>定义Shebang</p>
</div></blockquote>
</li>
<li><p>第三行到第五行</p>
<blockquote>
<div><p>检查临时文件 expire-check.tmp 是否存在于当前目录中，如果存在则使用rm命令删除expire-check.tmp。第三行中的“-e”是一个文件运算符，用于验证文件是否存在。</p>
</div></blockquote>
</li>
<li><p>第七行</p>
<blockquote>
<div><p>在“date +%s”中，通过计算从1970年1月1日0点0分0秒开始到现在的秒数，然后除以60秒除以60秒除以24小时，计算天数并将其赋值给today变量。</p>
</div></blockquote>
</li>
<li><p>第八行</p>
<blockquote>
<div><p>将代表分割符的环境变量IFS(Internal Filed Separator)设置为“:”。</p>
</div></blockquote>
</li>
<li><p>第九行</p>
<blockquote>
<div><p>将计数器n的用户数初始化为“0”。</p>
</div></blockquote>
</li>
<li><p>第十一行到第十六行</p>
<blockquote>
<div><p>以“:”分隔的方式读取 <code class="docutils literal notranslate"><span class="pre">/etc/shadow</span></code> 文件，其中$b字段（密码）不是“*”（未设置）或“!!”（锁定），且$h字段（到期前的天数）不是空字符串，然后从$h字段（到期前的天数）减去$today（现在的天数），并将其得数与用户名一起输出到expire-check.tmp中。$”\t”表示插入制表符进行缩进。将计数器$n的用户数设置为+1。</p>
</div></blockquote>
</li>
<li><p>第十八行</p>
<blockquote>
<div><p>将结果显示标题输出到expire-check.list中（如果文件已经存在，则将其覆盖）</p>
</div></blockquote>
</li>
<li><p>第十九行</p>
<blockquote>
<div><p>使用sort命令的“-k 2”参数按照第二个字段（剩余天数）对expire-check.tmp进行升序排序。使用“-g”参数将第二个字段视为数字。之后将结果追加到expire-check.list中。</p>
</div></blockquote>
</li>
<li><p>第二十行</p>
<blockquote>
<div><p>在expire-check.list中用括号括起来用户数量和执行日期。</p>
</div></blockquote>
</li>
<li><p>第二十一行</p>
<blockquote>
<div><p>使用cat命令标准输出expire-check.list</p>
</div></blockquote>
</li>
<li><p>第二十三行</p>
<blockquote>
<div><p>使用mail命令，向localhost.localdomain发送电子邮件。标题为“当前日期：expire-check”，正文内容为从expire-check.list中读取的内容。</p>
</div></blockquote>
</li>
</ul>
<p>以下是root用户身份运行的脚本文件“check.sh”：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># bash check.sh
用户:           剩余天数
mana:            58 天
yuko:            119 天
ryo:             303 天
（属于过期账户的用户：3人，当前时间03/03/2020）
# ls -l expire-check.list
-rw-r--r--. 1 root root 134 Mar  3 22:24 expire-check.list
</pre></div>
</div>
<p>显示用户ryo、mana和yuko的过期天数。此外，“check.sh”脚本还在当前目录下创建了“expire-check.list”文件。“check.sh”shell脚本使用mail命令将“expire-check.list”中的信息发送给“<a class="reference external" href="mailto:root&#37;&#52;&#48;localhost&#46;localdomain">root<span>&#64;</span>localhost<span>&#46;</span>localdomain</a>”。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># id
uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
You have new mail in /var/spool/mail/root
# mail
Heirloom Mail version 12.5 7/5/10.  Type ? for help.
&quot;/var/spool/mail/root&quot;: 2 messages 1 new
    1 root                  Tue Mar  3 21:44  21/769   &quot;Tue Mar  3 21:44:26 CST 2020: expire-check&quot;
&gt;N  2 root                  Tue Mar  3 22:24  22/789   &quot;Tue Mar  3 22:24:34 CST 2020: expire-check&quot;
&amp; 2
Message  2:
From root@localhost.localdomain  Tue Mar  3 22:24:34 2020
Return-Path: &lt;root@localhost.localdomain&gt;
X-Original-To: root@localhost.localdomain
Delivered-To: root@localhost.localdomain
Date: Tue, 03 Mar 2020 22:24:34 +0800
To: root@localhost.localdomain
Subject: Tue Mar  3 22:24:34 CST 2020: expire-check
User-Agent: Heirloom mailx 12.5 7/5/10
Content-Type: text/plain; charset=utf-8
From: root@localhost.localdomain (root)
Status: R

用户:           剩余天数
mana:            58 天
yuko:            119 天
ryo:             303 天
（属于过期账户的用户：3人，当前时间03/03/2020）

&amp; q
Held 2 messages in /var/spool/mail/root
</pre></div>
</div>
<p>在本节中，我们不对mail命令做详细说明。在上面的示例中，mail命令将显示您收到的邮件，您可以输入要查看的邮件的编号，然后按Enter键查看邮件内容。要推出，请输入q。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>为了便于查看接受到的邮件，可以使用以下步骤隐藏mail命令中通常不需要查看的邮件的邮件标题字段：</p>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cp /etc/mail.rc ~/.mailrc
# vi ~/.mailrc
# This is the configuration file for Heirloom mailx (formerly
# known under the name &quot;nail&quot;.
# See mailx(1) for further options.
# This file is not overwritten when &#39;make install&#39; is run in
# the mailx build process again.

# Sccsid @(#)nail.rc    2.11 (gritter) 8/2/08

# Do not forward to mbox by default since this is likely to be
# irritating for most users today.
set hold

# Append rather than prepend when writing to mbox automatically.
# This has no effect unless &#39;hold&#39; is unset again.
set append

# Ask for a message subject.
set ask

# Assume a CRT-like terminal and invoke a pager.
set crt

# Messages may be terminated by a dot.
set dot

# Do not remove empty mail folders in the spool directory.
# This may be relevant for privacy since other users could
# otherwise create them with different permissions.
set keep

# Do not remove empty private mail folders.
set emptybox

# Quote the original message in replies by &quot;&gt; &quot; as usual on the Internet.
set indentprefix=&quot;&gt; &quot;

# Automatically quote the text of the message that is responded to.
set quote

# Outgoing messages are sent in ISO-8859-1 if all their characters are
# representable in it, otherwise in UTF-8.
set sendcharsets=iso-8859-1,utf-8

# Display sender&#39;s real names in header summaries.
set showname

# Display the recipients of messages sent by the user himself in
# header summaries.
set showto

# Automatically check for new messages at each prompt, but avoid polling
# of IMAP servers or maildir folders.
set newmail=nopoll

# If threaded mode is activated, automatically collapse thread.
set autocollapse

# Mark messages that have been answered.
set markanswered

# Hide some header fields which are uninteresting for most human readers.
ignore received in-reply-to message-id references
ignore mime-version content-transfer-encoding

# Only include selected header fields when forwarding messages.
fwdretain subject date from to

# For Linux and BSD, this should be set.
set bsdcompat
</pre></div>
</div>
</div>
<div class="section" id="cron">
<h2>注册cron<a class="headerlink" href="#cron" title="永久链接至标题">¶</a></h2>
<p>现在，我们将注册cron以定期运行check.sh。在本例中，我们将“check.sh”设置为在月末自动执行。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># crontab -e
55 23 28-31 * * /usr/bin/test `date -d tomorrow +%d` -eq 1 &amp;&amp; /bin/bash /root/check.sh
# crontab -l
55 23 28-31 * * /usr/bin/test `date -d tomorrow +%d` -eq 1 &amp;&amp; /bin/bash /root/check.sh
</pre></div>
</div>
<p>上述示例包括如下内容：</p>
<ul class="simple">
<li><p>在每月的28日到31日的23点55分启动</p></li>
<li><p>另外，只有在明天为下月1号时才执行“check.sh”</p></li>
</ul>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/linux.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">《Linux 基础实践入门》</a></h1>








<h3>导航</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Chapter_1/1.Linux_overview.html">第一章 Linux 概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter_2/2.start_and_stop_linux.html">第二章 Linux的启动和停止</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter_3/3.opration_and_use_of_files.html">第三章 文件的操作与使用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter_4/4.Register_modify_delete_user.html">第四章 管理用户</a></li>
<li class="toctree-l1"><a class="reference internal" href="5.Execute_scripts_and_tasks.html">第五章 执行脚本和任务</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendix_A/A.Create_a_virtual_environment.html">附录A 创建虚拟环境</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, renkeju.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>